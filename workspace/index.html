<!DOCTYPE html>
<html>
<head>

<script>

var intervalCaller;
function getData(postCode)
{
    console.log(postCode);
    var xhttp = new XMLHttpRequest();

    xhttp.open("GET", "http://localhost:3000/closestStops?postcode="+postCode, false);

    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.setRequestHeader('Access-Control-Allow-Headers', '*');
    xhttp.setRequestHeader("Access-Control-Allow-Origin", 'http://localhost:3000');

    xhttp.send();

    return xhttp.responseText;
}

function reload()
{
    var postcode = document.getElementById("postCodeTextfield").value;
    if(intervalCaller != undefined) {
        clearInterval(intervalCaller);
    }   
    displayData(getData(postcode));
    intervalCaller = setInterval(function(){
    displayData(getData(postcode))}, 30000)
}

function displayData(data) {
    if(data.startsWith("Error")){
        document.getElementById("station1").innerHTML = data;
        document.getElementById("station2").innerHTML = "";
        document.getElementById("buslist1").innerHTML = "";
        document.getElementById("buslist2").innerHTML = "";
        return;
    }
    
    var response = JSON.parse(data);
    document.getElementById("station1").innerHTML = "<b>"+response[0]["commonName"]+":</b>";
    var text1 = "";
    for (var i = 0; i<response[0]["nextBuses"].length; i++) {
        text1 += "<li>"+response[0]["nextBuses"][i]["lineName"]+" - "+response[0]["nextBuses"][i]["towards"]+"("+response[0]["nextBuses"][i]["destinationName"]+") arriving in less than "+Math.ceil(response[0]["nextBuses"][i]["timeToStation"]/60).toString()+" min</li>";
    }
    document.getElementById("buslist1").innerHTML = text1;
    document.getElementById("station2").innerHTML = "<b>"+response[1]["commonName"]+":</b>";
    var text2 = "";
    for (var i = 0; i<response[1]["nextBuses"].length; i++) {
        text2 += "<li>"+response[1]["nextBuses"][i]["lineName"]+" - "+response[1]["nextBuses"][i]["towards"]+"("+response[1]["nextBuses"][i]["destinationName"]+") arriving in less than "+Math.ceil(response[1]["nextBuses"][i]["timeToStation"]/60).toString()+" min</li>";
    }
    document.getElementById("buslist2").innerHTML = text2;
}
</script>
</head>


<body>
  Post Code:<br>
  <input type="text" id = "postCodeTextfield" name="postcode"  placeholder="postcode">
   <button onclick="reload()">Try it</button> 

    <p id="station1"></p>
    <ul id="buslist1"></ul>
    <p id="station2"></p>
    <ul id="buslist2"></ul> 
</body>

</html>